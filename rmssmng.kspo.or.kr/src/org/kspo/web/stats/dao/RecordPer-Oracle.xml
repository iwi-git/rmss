<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.kspo.web.stats.dao.RecordPerDAO">
	
	<select id="selectRecordPer" parameterType="KSPOMap" resultType="KSPOMap">
		/*org.kspo.web.stats.dao.RecordPerDAO.selectRecordPer*/
		SELECT
			COUNT(*) OVER() AS TOTAL_RECORD_COUNT
			, ROW_NUMBER() OVER(ORDER BY B10.MLTR_ID DESC) AS RNUM
			, B10.MLTR_ID
			, TO_CHAR(TO_DATE(B10.ADDM_DT, 'YYYYMMDD'), 'YYYY-MM-DD') AS ADDM_DT
			, B10.APPL_SN
			, B10.APPL_NM
			, F_GET_MASK(#{USER_DV}, #{gMenuSn},'NAME',B10.APPL_NM) AS M_APPL_NM
			, B10.VLUN_DUTY_HR
			, TO_CHAR(TO_DATE(B10.BRTH_DT, 'YYYYMMDD'), 'YYYY-MM-DD') AS BRTH_DT
			, F_GET_MASK(#{USER_DV}, #{gMenuSn},'BIRTH',B10.BRTH_DT) AS M_BRTH_DT
			, B10.GAME_CD
			, (SELECT MAX(A.CNTNT_FST) FROM TRMZ_CMMN_CODE_D A WHERE A.ALT_CODE = B10.GAME_CD AND A.CMMN_SN = '202111050000341') AS GAME_NM
			, TO_CHAR(TO_DATE(B10.EXPR_DT, 'YYYYMMDD'), 'YYYY-MM-DD') AS EXPR_DT
			, TO_CHAR(TO_DATE(B10.EXPR_DT, 'YYYYMMDD'), 'YYYY-MM-DD') AS RSVT_DT
			, B10.MEMORG_SN
			, B10.MEMORG_NM
			, TRUNC(B10.FINAL_ACT_TIME_FORMAT_MN / 60) AS TOT_FINAL_ACT_TIME_HR
			, MOD(B10.FINAL_ACT_TIME_FORMAT_MN, 60) AS TOT_FINAL_ACT_TIME_MN
			, B10.TOT_FINAL_WP_MV_TIME
			, (TRUNC(B10.FINAL_ACT_TIME_FORMAT_MN / 60) + B10.TOT_FINAL_WP_MV_TIME) AS TOT_FINAL_TIME_HR
			, MOD(B10.FINAL_ACT_TIME_FORMAT_MN, 60) AS TOT_FINAL_TIME_MN
			, TRUNC( ((B10.VLUN_DUTY_HR * 60) - (B10.FINAL_ACT_TIME_FORMAT_MN) - (B10.TOT_FINAL_WP_MV_TIME * 60)) / 60) AS FINAL_REMAIN_TIME_HR
			, MOD( ((B10.VLUN_DUTY_HR * 60) - (B10.FINAL_ACT_TIME_FORMAT_MN) - (B10.TOT_FINAL_WP_MV_TIME * 60)), 60) AS FINAL_REMAIN_TIME_MN
		FROM (
			SELECT 
				A10.MLTR_ID 
				, A10.ADDM_DT
				, A10.APPL_SN 
				, A10.APPL_NM
				, A10.VLUN_DUTY_HR 
				, A10.BRTH_DT
				, A10.GAME_CD
				, A10.EXPR_DT
				, A10.RSVT_DT
				, A10.MEMORG_SN
				, A10.MEMORG_NM
				, NVL(SUM( (NVL(A10.TOT_AFT_ACT_TIME_HR, A10.TOT_PC_ACT_TIME_HR) * 60) + NVL(A10.TOT_AFT_ACT_TIME_MN, A10.TOT_PC_ACT_TIME_MN) ), 0) AS FINAL_ACT_TIME_FORMAT_MN
				, NVL(SUM( NVL(A10.TOT_AFT_WP_MV_TIME, A10.TOT_PC_WP_MV_TIME)), 0) AS TOT_FINAL_WP_MV_TIME
			FROM (	
					SELECT 
						TAAI.MLTR_ID
						, TAAI.ADDM_DT
						, TAI.APPL_SN
						, TAI.APPL_NM
						, TAI.VLUN_DUTY_HR
						, TAI.BRTH_DT
						, TAI.GAME_CD
						, TAI.EXPR_DT
						, TAI.RSVT_DT
						, TAI.MEMORG_SN
						, TMMI.MEMORG_NM
						, TVRM.TOT_PC_ACT_TIME_HR
						, TVRM.TOT_PC_ACT_TIME_MN
						, TVRM.TOT_PC_WP_MV_TIME 
						, TVRM.TOT_AFT_ACT_TIME_HR
						, TVRM.TOT_AFT_ACT_TIME_MN
						, TVRM.TOT_AFT_WP_MV_TIME 
						, TVRM.RECD_STS
						, TVPI.PLAN_STS
						, TAI.APPL_STS
						, TAI.PROC_STS 
					FROM TRMM_APPL_I TAI 
					INNER JOIN TRMZ_MEMORG_MNG_I TMMI 
						ON TMMI.MEMORG_SN = TAI.MEMORG_SN
					LEFT OUTER JOIN TRMM_APPL_ACPT_I TAAI 
						ON TAAI.APPL_SN = TAI.APPL_SN 
					LEFT OUTER JOIN TRMV_VLUN_PLAN_I TVPI 
						ON TVPI.MLTR_ID = TAAI.MLTR_ID 
					LEFT OUTER JOIN TRMV_VLUN_RECD_M TVRM 
						ON TVRM.VLUN_PLAN_SN = TVPI.VLUN_PLAN_SN 
					WHERE 1=1
						AND TAAI.MLTR_ID = #{MLTR_ID}
						AND TVRM.RECD_STS = 'MY'
						AND TVPI.PLAN_STS = 'KY'
						AND TAI.APPL_STS = 'MY'
			) A10
			WHERE 1=1 
			GROUP BY A10.MLTR_ID, A10.ADDM_DT, A10.APPL_SN, A10.APPL_NM, A10.VLUN_DUTY_HR, A10.BRTH_DT, A10.GAME_CD, A10.EXPR_DT, A10.RSVT_DT, A10.MEMORG_SN, A10.MEMORG_NM
		) B10
	</select>
	
	<select id="selectRecordPerList" parameterType="KSPOMap" resultType="KSPOMap">
		SELECT
			TO_CHAR(TO_DATE(A10.ACT_DT, 'YYYYMMDD'), 'YYYY-MM-DD') AS ACT_DT
			, A10.ACT_FIELD
			, DBMS_LOB.SUBSTR(A10.SRVC_CONTENTS) AS SRVC_CONTENTS
			, A10.VLUN_PLC_SN
			, A10.VLUN_PLC_NM
			, A10.PLC_MNGR_NM
			, F_GET_MASK(#{USER_DV}, #{gMenuSn},'NAME',A10.PLC_MNGR_NM) B_PLC_MNGR_NM  
			, TO_CHAR(A10.REG_DTM, 'YYYY-MM-DD') AS REG_DTM
			, A10.ACT_TIME_HR
			, A10.ACT_TIME_MN
			, A10.WP_MV_TIME
			, (A10.ACT_TIME_HR + A10.WP_MV_TIME) AS TOT_ACCEPT_TIME_HR
			, A10.ACT_TIME_MN AS TOT_ACCEPT_TIME_MN
		FROM (
			SELECT
				TVRD.ACT_DT
				, NVL(TVRD.AFT_ACT_TIME_HR, TVRD.PC_ACT_TIME_HR) AS ACT_TIME_HR 
				, NVL(TVRD.AFT_ACT_TIME_MN, TVRD.PC_ACT_TIME_MN) AS ACT_TIME_MN 
				, NVL(TVRD.AFT_WP_MV_TIME, TVRD.PC_REC_WP_MV_TIME) AS WP_MV_TIME
				, (SELECT ACT_FIELD_CODE.CNTNT_FST FROM TRMZ_CMMN_CODE_D ACT_FIELD_CODE WHERE ACT_FIELD_CODE.ALT_CODE = TVPI.ACT_FIELD AND ACT_FIELD_CODE.CMMN_SN = '202111050000342') AS ACT_FIELD
				, TVRD.SRVC_CONTENTS
				, TVPI.VLUN_PLC_SN
				, PLACE.VLUN_PLC_NM
				, PLACE.PLC_MNGR_NM 
				, TVRD.REG_DTM 
			FROM 
				TRMV_VLUN_RECD_D TVRD
			INNER JOIN TRMV_VLUN_RECD_M TVRM
				ON TVRM.VLUN_RECD_SN = TVRD.VLUN_RECD_SN
			INNER JOIN TRMV_VLUN_PLAN_I TVPI 
				ON TVPI.VLUN_PLAN_SN = TVRM.VLUN_PLAN_SN 
			INNER JOIN TRMV_VLUN_PLACE_I PLACE 
				ON PLACE.VLUN_PLC_SN = TVPI.VLUN_PLC_SN 
			INNER JOIN TRMM_APPL_ACPT_I TAAI 
				ON TAAI.MLTR_ID = TVPI.MLTR_ID
			INNER JOIN TRMM_APPL_I TAI
				ON TAI.APPL_SN = TAAI.APPL_SN
			WHERE 1=1
				AND TVRM.RECD_STS = 'MY'
				AND TVPI.PLAN_STS = 'KY'
				AND TAI.APPL_STS = 'MY'
				AND TAAI.MLTR_ID  = #{MLTR_ID}
		) A10
		ORDER BY A10.ACT_DT ASC
	</select>
</mapper>